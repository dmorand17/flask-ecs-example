name: Deploy to AWS ECS

on:
  push:
    branches: [main]
  workflow_dispatch: # Allow manual triggering

# Need ID token write permission to use OIDC
permissions:
  id-token: write # Required for requesting the JWT
  contents: read # Required for actions/checkout

jobs:
  # Job 1: Build and push Docker image to ECR
  build:
    name: Build & Push to ECR
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.image-info.outputs.tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.ASSUME_ROLE_ARN }}
          aws-region: us-east-1

      - name: Verify AWS Identity
        run: aws sts get-caller-identity

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Generate image tag
        id: image-info
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          IMAGE_TAG="${SHORT_SHA}-$(date +%s)"
          echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "Image tag: ${IMAGE_TAG}"

      - name: Build and Push Docker image to ECR
        run: |
          docker buildx build \
            --platform linux/amd64 \
            -t ${{ vars.ECR_REPO }}:${{ steps.image-info.outputs.tag }} \
            -t ${{ vars.ECR_REPO }}:latest \
            --push .

  # Job 2: Deploy to ECS
  deploy:
    name: Deploy to ECS
    runs-on: ubuntu-latest
    needs: build # Only run after successful build
    environment:
      name: production
      url: ${{ steps.get-url.outputs.url }}
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.ASSUME_ROLE_ARN }}
          aws-region: us-east-1

      - name: Deploy to ECS Express Service
        id: deploy
        run: |
          echo "Deploying image: ${{ vars.ECR_REPO }}:${{ needs.build.outputs.image-tag }}"

          aws ecs update-express-gateway-service \
            --service-arn "${{ vars.ECS_SERVICE_ARN }}" \
            --primary-container '{
              "image": "${{ vars.ECR_REPO }}:${{ needs.build.outputs.image-tag }}"
            }'

      - name: Wait for deployment to complete
        run: |
          echo "Waiting for service to stabilize..."
          SERVICE_NAME=$(echo "${{ vars.ECS_SERVICE_ARN }}" | awk -F'/' '{print $NF}')
          CLUSTER_ARN=$(aws ecs describe-services --services "${{ vars.ECS_SERVICE_ARN }}" --query 'services[0].clusterArn' --output text)

          aws ecs wait services-stable \
            --cluster "${CLUSTER_ARN}" \
            --services "${SERVICE_NAME}"

          echo "âœ… Deployment completed successfully!"

      - name: Get service URL
        id: get-url
        run: |
          # Extract the service URL from ECS service description
          SERVICE_URL=$(aws ecs describe-services \
            --services "${{ vars.ECS_SERVICE_ARN }}" \
            --query 'services[0].serviceConnectConfiguration.services[0].clientAliases[0].dnsName' \
            --output text 2>/dev/null || echo "URL not available")

          echo "url=https://${SERVICE_URL}" >> $GITHUB_OUTPUT
          echo "Service URL: ${SERVICE_URL}"

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag:** ${{ needs.build.outputs.image-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Service ARN:** ${{ vars.ECS_SERVICE_ARN }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Region:** us-east-1" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed By:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
